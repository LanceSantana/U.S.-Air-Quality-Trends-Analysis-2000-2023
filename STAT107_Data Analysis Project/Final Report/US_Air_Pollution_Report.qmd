---
title: "US Air Pollution Report"
author: "Ivan Avila, Lance Santana, Cole Hammes, Gustavo Perez"
date: "December 11th, 2024"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(maps)
airquality_data <- read_csv("pollution_2000_2023.csv")
```

##GUSTAVO

```{r}
highest_City<- airquality_data %>%
  filter(year(Date)==2023)%>%
  group_by(City)%>%
  summarize(M_CO=mean(`CO AQI`))%>%
  arrange(desc(M_CO))
head(highest_City,6)

low_City<- airquality_data %>%
  filter(year(Date)==2023)%>%
  group_by(City)%>%
  summarize(M_CO=mean(`CO AQI`))%>%
  arrange((M_CO))
head(low_City,3)
```

```{r}
find_city<-function(pollutant){
  
  chosen_City<- airquality_data %>%
    filter(year(Date)==2023)%>%
    group_by(City)%>%
    summarize(avg_pollutant=mean(.data[[pollutant]],na.rm = TRUE))%>%
    arrange(desc(avg_pollutant))
  head(chosen_City,3)
}

Pol_city<-function(x){
  CO_plot<-data.frame(
   index=integer(),
   CO_M=numeric())

  PH<-airquality_data %>%
    filter(City %in% c(x))%>%
    arrange((Date))


  for (i in 2000:2023){
    PH_data<- PH %>%
      filter(year(Date)==i)
    CO_data<-c(mean(PH_data$`CO AQI`,na.rm = TRUE))
    
    CO_plot <- rbind(CO_plot, data.frame(index = i, CO_M = CO_data))
  }
  
  
  ggplot (CO_plot,aes(x=index,y=CO_M))+
    geom_line(color='black',size=1)+
    geom_point(color='red',size=2)+
    labs(title=paste('Average Carbon Monoxide Air Quality Index in',x,'from 2000-2023'),
        x="Year", y= 'Carbon Monoxide')
} 

Calexico_Pol<-Pol_city(c('Phoenix'))
Calexico_Pol

LA_Pol<-Pol_city(c('Los Angeles'))
LA_Pol

Lompoc_Pol<-Pol_city(c('Lompoc'))
Lompoc_Pol
```

```{r}
data("us.cities")
HI<-us.cities
LA<- us.cities%>%
  filter(name=='Los Angeles CA')
city_LA<- data.frame(x=LA$lat,y=LA$long)

LP<- us.cities%>%
  filter(name=='Lompoc CA')
city_LP<- data.frame(x=LP$lat,y=LP$long)

PH<- us.cities%>%
  filter(name=='Phoenix AZ')
city_PH<- data.frame(x=PH$lat,y=PH$long)

CH<- us.cities%>%
  filter(name== 'Cheyenne WY')
city_CH<- data.frame(x=CH$lat,y=CH$long)

DA<- us.cities%>%
  filter(name== 'Dallas TX')
city_DA<- data.frame(x=DA$lat,y=DA$long)

FR<- us.cities%>%
  filter(name== 'Fresno CA')
city_FR<- data.frame(x=FR$lat,y=FR$long)

map<-map_data('state')
ggplot()+
  geom_polygon(data=map,aes(x=long,y=lat,group=group),fill='white',color='black')+
  geom_point(data=city_LA,aes(x=y,y=x),color='red',size=3)+
  geom_text(data=city_LA,aes(x=y,y=x,label='Los Angeles'),vjust=1)+
          
  geom_point(data=city_FR,aes(x=y,y=x),color='red',size=3)+
  geom_text(data=city_FR,aes(x=y,y=x,label='Fresno'),vjust=-1)+
            
  geom_point(data=city_LP,aes(x=y,y=x),color='darkgreen',size=5,shape=18)+
  geom_text(data=city_LP,aes(x=y,y=x,label='Lompoc'),vjust=-1)+
            
  geom_point(data=city_PH,aes(x=y,y=x),color='red',size=3)+
  geom_text(data=city_PH,aes(x=y,y=x,label='Phoenix'),vjust=-1,size=3)+
            
  geom_point(data=city_CH,aes(x=y,y=x),color='darkgreen',size=5,shape=18)+
  geom_text(data=city_CH,aes(x=y,y=x,label='Cheyenne'),vjust=2,size=3)+  
    
  geom_point(data=city_DA,aes(x=y,y=x),color='darkgreen',size=5,shape=18)+
  geom_text(data=city_DA,aes(x=y,y=x,label='Dallas'),vjust=2,size=3)+
  labs(title='Highest and Lowest location of Carbon Monoxide',x='Long',y='Lat')
```

```{r}
Pol_compare<-function(x){
  combine_p<-data.frame(
   index=integer(),
   Value=numeric(),
   Pollutant=character())
  
  
  
  PH<-airquality_data %>%
    filter(City %in% c(x))%>%
    arrange((Date))


  for (i in 2000:2023){
    PH_data<- PH %>%
      filter(year(Date)==i)
    CO_data<-c(mean(PH_data$`CO AQI`,na.rm = TRUE))
    NO2_data<-c(mean(PH_data$`NO2 AQI`,na.rm = TRUE))
    SO2_data<-c(mean(PH_data$`SO2 AQI`,na.rm = TRUE))
    O3_data<-c(mean(PH_data$`O3 AQI`,na.rm = TRUE))
    
    combine_p<-rbind(combine_p,data.frame(index=i,value=CO_data,Pollutant='Carbon Monoxide'))
    combine_p<-rbind(combine_p,data.frame(index=i,value=NO2_data,Pollutant='Nitrogen Dioxide'))
    combine_p<-rbind(combine_p,data.frame(index=i,value=SO2_data,Pollutant='Sulfur Dioxide'))
    combine_p<-rbind(combine_p,data.frame(index=i,value=O3_data,Pollutant='Ozone'))
  }
  
  
  ggplot (combine_p,aes(x=index,y=value,color=Pollutant,group=Pollutant))+
    geom_line()+
    geom_point()+
    labs(title=paste('Average Pollutants Air Quality Index in',x,'from 2000-2023'),
        x="Year", y= 'AQI Value')+
    scale_color_manual(values=c("Carbon Monoxide"='red',"Nitrogen Dioxide"='darkgrey',"Sulfur Dioxide"='black',"Ozone"='darkgreen'))
}

Pollutants_avg<-Pol_compare(c('Los Angeles'))
Pollutants_avg
```

##IVAN

```{r}
#Summary Stats for NO2
NO2_summary <- airquality_data %>%
  summarize(
    Mean_NO2 = mean(`NO2 AQI`, na.rm = TRUE),
    Median_NO2 = median(`NO2 AQI`, na.rm = TRUE),
    Min_NO2 = min(`NO2 AQI`, na.rm = TRUE),
    Max_NO2 = max(`NO2 AQI`, na.rm = TRUE),
    stdev_NO2 = sd(`NO2 AQI`, na.rm = TRUE),
    Observations = n()
  )

NO2_summary
```

```{r}
#Identifying outliers function for respective state
identifying_outliers <- function(data, state_name) {
  state_data <- data %>%
    filter(State == state_name)
  
  stats <- state_data %>%
    summarise(
      Q1 = quantile(`NO2 AQI`, 0.25, na.rm = TRUE),
      Q3 = quantile(`NO2 AQI`, 0.75, na.rm = TRUE)
    ) %>%
    mutate(
      IQR = Q3 - Q1,
      lower_bound = Q1 - 1.5 * IQR,
      upper_bound = Q3 + 1.5 * IQR
    )
  
  outliers <- state_data %>%
    filter(`NO2 AQI` < stats$lower_bound | `NO2 AQI` > stats$upper_bound)
  return(outliers)
}
```

```{r}

#Visualization function for outliers
visualize_outliers <- function(data, state_name) {
  state_data <- data %>% 
    filter(State == state_name) %>%
    mutate(Year = year(Date))
  
  outliers <- identifying_outliers(data, state_name) %>%
    mutate(Year = year(Date))
  
  outlier_plot <- ggplot(state_data, aes(x = factor(Year), y = `NO2 AQI`)) +
    geom_boxplot(alpha = 0.8)+
    geom_point(data = outliers, aes(x = factor(Year), y = `NO2 AQI`),
               color = 'blue', size = 1)+
    labs(
      title = paste("Outliers in NO2 AQI for", state_name, "by Year"),
      x = "Year",
      y = "NO2 AQI")
      
                    
  return(outlier_plot)
  
}
```

```{r}
outliers_cali <- visualize_outliers(airquality_data, "California")

outliers_cali
```

Question: Which states have the highest average levels of nitrogen dioxide (NO2) AQI?

Task: Create a map highlighting states by their average NO2 AQI levels to visualize geographical patterns in pollution.

```{r}
#Creates a United States Map for a respective year to compare NO2 values
filtered_year_2000 <- airquality_data %>%
  mutate(Year = year(Date)) %>%
  filter(Year == 2000)

#creates new dataset and specifically looks for states and reorder them
state_avg_NO2_2000 <- filtered_year_2000 %>%
  group_by(State) %>%
  summarize(Avg_NO2_AQI = mean(`NO2 AQI`, na.rm = TRUE)) %>%
  mutate(State = tolower(State))

#imports map
map_data_states <- map_data("state")

avg_NO2_merged_states_2000 <- map_data_states %>%
  left_join(state_avg_NO2_2000, by = c("region" = "State"))

state_center <- avg_NO2_merged_states_2000 %>%
  group_by(region) %>%
  summarize(
    long = mean(range(long)),
    lat = mean(range(lat)),
    Avg_NO2_AQI= unique(Avg_NO2_AQI)
  ) %>%
  filter(!is.na(Avg_NO2_AQI))

#creates map
ggplot(avg_NO2_merged_states_2000, aes(x = long, y = lat, group = group, fill = Avg_NO2_AQI)) +
  geom_polygon(color = "white") +
  geom_text(data = state_center, aes(x = long, y = lat, label = round(Avg_NO2_AQI, 1)),
            inherit.aes = FALSE, color = "black", size = 3) +
  scale_fill_gradient(low = "blue", high = "red", na.value = "grey") +
  labs(title = "Average NO2 AQI by State in 2000",
       fill = "Avg_NO2_AQI") 

```

```{r}
#Creates a United States Map for a respective year to compare NO2 values
filtered_year_2023 <- airquality_data %>%
  mutate(Year = year(Date)) %>%
  filter(Year == 2023)

#creates new dataset and specifically looks for states and reorder them
state_avg_NO2_2023 <- filtered_year_2023 %>%
  group_by(State) %>%
  summarize(Avg_NO2_AQI = mean(`NO2 AQI`, na.rm = TRUE)) %>%
  mutate(State = tolower(State))

#imports map
map_data_states <- map_data("state")

avg_NO2_merged_states_2023 <- map_data_states %>%
  left_join(state_avg_NO2_2023, by = c("region" = "State"))

#Calculates the center of the states in order to plot numbers
state_center <- avg_NO2_merged_states_2023 %>%
  group_by(region) %>%
  summarize(
    long = mean(range(long)),
    lat = mean(range(lat)),
    Avg_NO2_AQI= unique(Avg_NO2_AQI)
  ) %>%
  filter(!is.na(Avg_NO2_AQI))

#creates map
ggplot(avg_NO2_merged_states_2023, aes(x = long, y = lat, group = group, fill = Avg_NO2_AQI)) +
  geom_polygon(color = "white") +
  geom_text(data = state_center, aes(x = long, y = lat, label = round(Avg_NO2_AQI, 1)),
            inherit.aes = FALSE, color = "black", size = 3) +
  scale_fill_gradient(low = "blue", high = "red", na.value = "grey") +
  labs(title = "Average NO2 AQI by State in 2023",
       fill = "Avg_NO2_AQI") 
```

```{r}
#top 5 states within 2023
top_5_states_2023 <- state_avg_NO2_2023 %>%
  arrange(desc(Avg_NO2_AQI)) %>%
  head(5)

top_5_states_2023

#top 5 states within 2000
top_5_states_2000 <- state_avg_NO2_2000 %>%
  arrange(desc(Avg_NO2_AQI)) %>%
  head(5)

top_5_states_2000
```

Question: How have NO2 levels changed over time in a selected State? Task: Filter for a specific State and plot a line chart of NO2 Mean by year. Comparing Max Values of Pollutants

```{r}
#Function filters and plots inputed city from dataset
analyze_state_pollution <- function(data, state_name) {
  state_data <- data %>%
    filter(State == state_name) %>%
    mutate(Year = as.integer(format(as.Date(Date, format = "%Y-%m-%d"), "%Y")))
  
#Checks if City input is indeed in the dataset  
  if (nrow(state_data) == 0) {
    stop(paste("No data available for", state_name))
  }
  
  state_yearly <- state_data %>%
    group_by(Year) %>%
    summarize(Mean_NO2 = mean(`NO2 AQI`, na.rm = TRUE),
              Max_NO2 = max(`NO2 AQI`, na.rm = TRUE),
              Max_O3 = max(`CO AQI`, na.rm = TRUE),
              Max_CO = max(`O3 AQI`, na.rm = TRUE),
              Max_SO2 = max(`SO2 AQI`, na.rm = TRUE))
  
  plot_mean_NO2 <- ggplot(state_yearly, aes(x = Year)) +
    geom_line(aes(y = Mean_NO2, color = "Mean NO2"), size = 1) +
    geom_point(aes(y = Mean_NO2, color = "Mean NO2"), size = 2) +
    labs(title = paste("Yearly Mean NO2 Levels in", state_name),
         x = "Year", y = "NO2 AQI",
         color = "Legend")
  
  plot_max_pollutants <- ggplot(state_yearly, aes(x = Year)) +
    geom_line(aes(y = Max_NO2, color = "Max NO2"), size = 1) +
    geom_line(aes(y = Max_O3, color = "Max O3"), size = 1, linetype = "dashed") +
    geom_line(aes(y = Max_CO, color = "Max CO"), size = 1, linetype = "dotted") +
    geom_line(aes(y = Max_SO2, color = "Max SO2"), size = 1, linetype = "dotdash") +
    labs(title = paste("Yearly Maximum Values of Pollutants in", state_name),
         x = "Year", y = "Pollutatnt AQI",
         color = "Pollutants") 
  return(list(Mean_NO2_Plot = plot_mean_NO2, MAx_Pollutants_Plot = plot_max_pollutants))
}
```

```{r}
cali_plots <- analyze_state_pollution(data = airquality_data, state_name = "California")

cali_plots
```

```{r}
col_plots <- analyze_state_pollution(data = airquality_data, state_name = "Colorado")

col_plots
```
